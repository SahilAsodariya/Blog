<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All Blog Posts</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/posts.css') }}"
    />
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  </head>
  <body>
    <div class="container">
      
      <header class="header">
        <h1>üìù All Blog Posts</h1>
       
        <a href="/explore/explore-page" class="user_search_btn" id="user_search_btn" style="display: none;">
          <svg xmlns="http://www.w3.org/2000/svg"  width="24" height="24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
  <circle cx="11" cy="11" r="8"></circle>
  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
</svg>
  
        </a>
      
        <div class="actions"></button>
          <div
            class="my-posts-toggle"
            style="display: flex; align-items: center"
          >
            <input
              type="checkbox"
              id="my_post"
              onchange="func()"
              style="display: none"
            />
            <label for="my_post" id="my_post_label" style="display: none"
              >Only see my posts</label
            >
          </div>

          <button
            id="user-btn"
            class="btn btn-secondary"
            onclick="goToAdminDashboard()"
            style="display: none"
          >
            All Users
          </button>
          <button
            id="profile-btn"
            class="btn btn-primary"
            onclick="goToProfile()"
            style="display: none"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v1.6c0 .4.3.8.8.8h17.6c.4 0 .8-.3.8-.8v-1.6c0-3.2-6.4-4.8-9.6-4.8z"
              />
            </svg>
          </button>
          <button
            id="login-btn"
            class="btn btn-primary"
            onclick="goToLogin()"
            style="display: none"
          >
            Login
          </button>
          <button
            id="register-btn"
            class="btn btn-secondary"
            onclick="goToRegister()"
            style="display: none"
          >
            Register
          </button>
        </div>
      </header>
      <div class="search-container">
        <input
          type="search"
          name="search"
          class="search"
          placeholder="Search posts..."
        />
      </div>
      <div id="posts-container" class="posts-container"></div>
      <div class="page-container"></div>
    </div>

    <script>
      const token = localStorage.getItem("access_token");
      const userId = localStorage.getItem("user_id");
      let is_admin = false;

      const socket = io();
      if (userId) {
        socket.emit("register_user", { user_id: userId });
        socket.on("notification", function (data) {
          alert(data.message);
        });
      }

      if (token) {
        document.getElementById("my_post_label").style.display = "inline-block";
        document.getElementById("my_post").style.display = "inline-block";
        document.getElementById("profile-btn").style.display = "inline-block";
        document.getElementById("user_search_btn").style.display = "inline-block";

      } else {
        document.getElementById("login-btn").style.display = "inline-block";
        document.getElementById("register-btn").style.display = "inline-block";
      }

      const func = async (page = 1) => {
        const search = document.querySelector(".search").value.trim();
        const showMyPosts = document.getElementById("my_post").checked;

        fetch(`/post?page=${page}&limit=10&search=${search}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((res) => res.json())
          .then((data) => {
            if (userId == data.admin) is_admin = true;
            if (token && is_admin)
              document.getElementById("user-btn").style.display =
                "inline-block";

            renderPagination(
              data.pagination.current_page,
              data.pagination.total_pages
            );

            const container = document.getElementById("posts-container");
            container.innerHTML = "";

            if (!data.posts || data.posts.length === 0) {
              container.innerHTML = `<p class="no-posts">No posts available.</p>`;
              return;
            }

            data.posts.forEach((post) => {
              if (showMyPosts && post.user_id != userId) return;

              const hasImage = post.file && post.file.trim() !== "";
              const postDiv = document.createElement("div");
              postDiv.className = "post-card";

              postDiv.innerHTML = `
            <div>
              <h2>${post.title}</h2>
              <p class="meta">By <strong>${
                post.username
              }</strong> ‚Ä¢ Posted on ${post.created_at}</p>
              <div class="content-img ${
                hasImage ? "side-by-side" : "text-only"
              }">
                <p class="content">${post.content}</p>
                ${
                  hasImage
                    ? `<img src="static/media/user_${userId}/${post.file}" class="img" alt="Post Image" />`
                    : ""
                }
              </div>
            </div>
            <div class="actions">
              ${
                token && userId == post.user_id
                  ? `<a href="/post/edit-page/${post.id}" class="btn btn-primary">Edit</a>`
                  : ""
              }
              ${
                (token && userId == post.user_id) || is_admin
                  ? `<a onclick="deletePost(${post.id})" class="btn btn-danger">Delete</a>`
                  : ""
              }
            </div>
            <div class="comments-section">
              <h4>üí¨ Comments</h4>
              <div class="comments-list" id="comments-${post.id}">
                ${
                  post.comments && post.comments.length > 0
                    ? post.comments
                        .map(
                          (comment) => `
                            <div class="comment">
                              <div style="flex: 12;">
                                <p><strong>${comment.user.username}:</strong> ${
                            comment.content
                          }</p>
                                <p class="meta">${new Date(
                                  comment.created_at
                                ).toLocaleString()}</p>
                              </div>
                              <div style="flex: 1;">
                                ${
                                  is_admin
                                    ? `<a onclick="deleteComment(${comment.id})" class="btn btn-danger">Delete</a>`
                                    : ""
                                }
                              </div>
                            </div>
                          `
                        )
                        .join("")
                    : `<p class="no-comments">No comments yet.</p>`
                }
              </div>
              ${
                token
                  ? `
                    <form class="comment-form" onsubmit="submitComment(event, ${post.id})">
                      <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment..." required />
                      <button type="submit" class="btn btn-small">Post</button>
                    </form>
                  `
                  : `<p class="comment-login-msg">Login to comment</p>`
              }
            </div>
          `;

              container.appendChild(postDiv);
            });
          })
          .catch((err) => {
            console.error("Error:", err);
            document.getElementById("posts-container").innerHTML =
              "<p style='color:red;'>Unable to fetch posts.</p>";
          });
      };

      const submitComment = (e, postId) => {
        e.preventDefault();
        const input = document.getElementById(`comment-input-${postId}`);
        const content = input.value.trim();
        if (!content) return;

        fetch(`/comment/add_comment/${postId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ content }),
        })
          .then((res) => res.json())
          .then(() => {
            input.value = "";
            func();
          })
          .catch(() => alert("Could not post comment."));
      };

      const deletePost = (postId) => {
        const isConfirmed = confirm("Are you sure you want to delete this post?");
        if (!isConfirmed) return;
        fetch(`/post/delete/${postId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            alert(data.message);
            func();
          })
          .catch((err) => alert("Error deleting post."));
      };

      const deleteComment = (commentId) => {
        fetch(`/admin/comment_delete/${commentId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            alert(data.message);
            func();
          })
          .catch(() => alert("Error deleting comment."));
      };

      document
        .querySelector(".search")
        .addEventListener("input", () => func(1));

      function renderPagination(currentPage, totalPages) {
        const pageContainer = document.querySelector(".page-container");
        pageContainer.innerHTML = "";

        const maxPages = 5;
        const half = Math.floor(maxPages / 2);
        let start = Math.max(1, currentPage - half);
        let end = Math.min(totalPages, currentPage + half);

        if (end - start < maxPages - 1) {
          if (start === 1) end = Math.min(start + maxPages - 1, totalPages);
          else if (end === totalPages) start = Math.max(end - maxPages + 1, 1);
        }

        if (currentPage > 1) {
          addButton("<<", 1);
          addButton("<", currentPage - 1);
        }

        for (let i = start; i <= end; i++) {
          const btn = document.createElement("div");
          btn.className = "page";
          if (i === currentPage) btn.classList.add("active");
          btn.textContent = i;
          btn.onclick = () => func(i);
          pageContainer.appendChild(btn);
        }

        if (currentPage < totalPages) {
          addButton(">", currentPage + 1);
          addButton(">>", totalPages);
        }

        function addButton(text, page) {
          const btn = document.createElement("div");
          btn.className = "page nav";
          btn.textContent = text;
          btn.onclick = () => func(page);
          pageContainer.appendChild(btn);
        }
      }

      function goToLogin() {
        window.location.href = "/auth/login";
      }
      function goToProfile() {
        window.location.href = "/profile/";
      }

      function goToRegister() {
        window.location.href = "/auth/register";
      }

      function goToAdminDashboard() {
        window.location.href = "/admin/only_admin";
      }
      func(1);
    </script>
  </body>
</html>
