<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/profile.css') }}"
    />
  </head>
  <body>
    <div class="profile-container">
      <!-- Profile Header -->
      <header class="profile-header" id="profile-header"></header>

      <!-- Posts Section -->
      <section class="posts-section">
        <h2 class="section-title"></h2>
        <div id="posts-container" class="posts-container"></div>
      </section>
    </div>

    <script>
      const token = localStorage.getItem("access_token");
      const userId = localStorage.getItem("user_id");
      let is_admin = false;

      if (!token) {
        document.getElementById("create-post-btn").style.display = "none";
        document.getElementById("logout-btn").style.display = "none";
      }

      const func = async () => {
        fetch(`/profile/data/${userId}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data["msg"]) {
              alert(`${data["msg"]}, please login again.`);
              window.location.href = "/auth/login";
            }
            is_admin = data.admin;

            // profile view

            const profile_pic = null;
            const header = document.getElementById("profile-header");
            header.innerHTML = "";

            header.innerHTML = `
            ${
              data.is_premium
                ? `<svg
             class="primium_tag"
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 64 64"
  width="32"
  height="32"
  aria-hidden="true"
  role="img"
>
  <defs>
    <linearGradient id="gold" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#FFE58A"/>
      <stop offset="45%" stop-color="#F7C948"/>
      <stop offset="100%" stop-color="#E6A700"/>
    </linearGradient>
    <linearGradient id="shine" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="rgba(255,255,255,0.6)"/>
      <stop offset="60%" stop-color="rgba(255,255,255,0)"/>
    </linearGradient>
  </defs>

  <!-- Base crown -->
  <path
    d="M6 47 L10 20 L24 32 L32 16 L40 32 L54 20 L58 47 Z"
    fill="url(#gold)"
    stroke="#9C6B00"
    stroke-width="2"
    stroke-linejoin="round"
  />
  <!-- Band -->
  <rect x="8" y="43" width="48" height="8" rx="3" fill="#E4B200" stroke="#9C6B00" stroke-width="2"/>
  <!-- Gems -->
  <circle cx="32" cy="38" r="3.5" fill="#56CCF2" stroke="#2F80ED" stroke-width="1.5"/>
  <circle cx="18" cy="40" r="2.8" fill="#EB5757" stroke="#C0392B" stroke-width="1.2"/>
  <circle cx="46" cy="40" r="2.8" fill="#6FCF97" stroke="#27AE60" stroke-width="1.2"/>

  <!-- Subtle top shine -->
  <path d="M9 27 C18 20, 46 20, 55 27" fill="none" stroke="url(#shine)" stroke-width="3" opacity="0.6"/>
</svg>`
                : " "
            }

            <button class="add_profile_btn"  onclick="goToAddProfilePic()">
      +
            </button>
            <img src="${
              data.user.profile_pictures
                ? `/static/media/user_${userId}/${data.user.profile_pictures}`
                : `/static/media/default_profile.png`
            }" alt="Profile Picture" class="profile-picture" ${
              data.is_premium ? 'style="border: 3px solid #FFD700;"' : ""
            } />
        <div class="info-btn-container">
           
        <div class="profile-info">
            <h1 class="username">${data.user.username}</h1>
            <p class="email">${data.user.email}</p>
            <p class="join-date">Joined At: ${new Date(
              data.user.joined_at
            ).toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })}</p>

            <div class="stats">
                <span><strong>${data.user.posts.length}</strong> Posts</span>
            </div>
        </div>
        ${
          data.is_premium
            ? `<a  class="subscribe-btn">Expire on ${new Date(
                data.subscription_end_date
              ).toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })}</a>`
            : `<a href="/subscription/subscription_plans" class="subscribe-btn">ðŸ‘‘ Become a Premium Member</a>`
        }   
        <div>
           <button
            id="create-post-btn"
            class="btn btn-primary"
            onclick="goToCreatePost()"
            
          >
            + Create New Post
          </button>
          
          <button
            id="logout-btn"
            class="btn btn-danger"
            onclick="logout()"
      
          >
            Logout
          </button>
        </div>
        
        </div>
        <div class="back-container">
      <a href="/" class="back_btn">X</a>
    </div>`;

            const container = document.getElementById("posts-container");
            container.innerHTML = "";

            if (!data.user_data || data.user_data.length === 0) {
              container.innerHTML = `<p class="no-posts">No posts available.</p>`;
              return;
            }

            // post view
            data.user_data.forEach((post) => {
              const hasImage = post.file && post.file.trim() !== "";
              const postDiv = document.createElement("div");
              postDiv.className = "post-card";

              postDiv.innerHTML = `
            <div>
              <h2>${post.title}</h2>
              <p class="meta">By <strong>${
                post.username
              }</strong> â€¢ Posted on ${post.created_at}</p>
              <div class="content-img ${
                hasImage ? "side-by-side" : "text-only"
              }">
                <p class="content">${post.content}</p>
                ${
                  hasImage
                    ? `<img src="/static/media/user_${userId}/${post.file}" class="img" alt="Post Image" />`
                    : ""
                }
              </div>
            </div>
            <div class="actions">
              ${
                token && userId == post.user_id
                  ? `<a href="/post/edit-page/${post.id}" class="btn btn-primary">Edit</a>`
                  : ""
              }
              ${
                (token && userId == post.user_id) || is_admin
                  ? `<a onclick="deletePost(${post.id})" class="btn btn-danger">Delete</a>`
                  : ""
              }
            </div>
            <div class="comments-section">
              <h4>ðŸ’¬ Comments</h4>
              <div class="comments-list" id="comments-${post.id}">
                ${
                  post.comments && post.comments.length > 0
                    ? post.comments
                        .map(
                          (comment) => `
                            <div class="comment">
                              <div style="flex: 12;">
                                <p><strong>${comment.user.username}:</strong> ${
                            comment.content
                          }</p>
                                <p class="meta">${new Date(
                                  comment.created_at
                                ).toLocaleString()}</p>
                              </div>
                              <div style="flex: 1;">
                                ${
                                  is_admin
                                    ? `<a onclick="deleteComment(${comment.id})" class="btn btn-danger">Delete</a>`
                                    : ""
                                }
                              </div>
                            </div>
                          `
                        )
                        .join("")
                    : `<p class="no-comments">No comments yet.</p>`
                }
              </div>
              ${
                token
                  ? `
                    <form class="comment-form" onsubmit="submitComment(event, ${post.id})">
                      <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment..." required />
                      <button type="submit" class="btn btn-small">Post</button>
                    </form>
                  `
                  : `<p class="comment-login-msg">Login to comment</p>`
              }
            </div>
          `;

              container.appendChild(postDiv);
            });
          })
          .catch((err) => {
            console.error("Error:", err);
            document.getElementById("posts-container").innerHTML =
              "<p style='color:red;'>Unable to fetch posts.</p>";
          });
      };

      const submitComment = (e, postId) => {
        e.preventDefault();
        const input = document.getElementById(`comment-input-${postId}`);
        const content = input.value.trim();
        if (!content) return;

        fetch(`/comment/add_comment/${postId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ content }),
        })
          .then((res) => res.json())
          .then(() => {
            input.value = "";
            func();
          })
          .catch(() => alert("Could not post comment."));
      };

      const deletePost = (postId) => {
        const isConfirmed = confirm("Are you sure you want to delete this post?");
        if (!isConfirmed) return;
        fetch(`/post/delete/${postId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            alert(data.message);
            func();
          })
          .catch((err) => alert("Error deleting post."));
      };

      const deleteComment = (commentId) => {
        fetch(`/admin/comment_delete/${commentId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            alert(data.message);
            func();
          })
          .catch(() => alert("Error deleting comment."));
      };

      function goToCreatePost() {
        window.location.href = "/post/create-page";
      }
      function logout() {
        localStorage.removeItem("access_token");
        localStorage.removeItem("user_id");
        window.location.href = "/";
      }

      function goToAddProfilePic() {
        window.location.href = `/profile/add_profile_pic/${userId}`;
      }

      func();
    </script>
  </body>
</html>
