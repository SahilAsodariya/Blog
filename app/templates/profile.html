<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/profile.css') }}"
    />
  </head>
  <body>
 <div class="profile-container">
  <!-- Profile Header -->
  <header class="profile-header" id="profile-header">
   
  <button class="add_profile_btn" onclick="goToAddProfilePic()">
      +
  </button>
    <img
      src=""
      alt="Profile Picture"
      class="profile-picture"
    />
    
    <div class="info-btn-container">
      <div class="profile-info">
        <h1 class="username">John Doe</h1>
        <p class="email">john@example.com</p>
        <p class="join-date">Joined on January 15, 2023</p>
        <div class="stats">
          <span><strong>12</strong> Posts</span>
        </div>
      </div>
      <div>
        <button
          id="create-post-btn"
          class="btn btn-primary"
          onclick="goToCreatePost()"
          style="display: none"
        >
          + Create New Post
        </button>

        <button
          id="logout-btn"
          class="btn btn-danger"
          onclick="logout()"
          style="display: none"
        >
          Logout
        </button>
      </div>
    </div>
    <div class="back-container">
   <a href="/" class="back_btn">X</a>
 </div>
  </header>

  <!-- Posts Section -->
  <section class="posts-section">
    <h2 class="section-title"></h2>
    <div id="posts-container" class="posts-container"></div>
  </section>
</div>


    <script>
      const token = localStorage.getItem("access_token");
      const userId = localStorage.getItem("user_id");
      let is_admin = false;

      if (token) {
        document.getElementById("create-post-btn").style.display =
          "inline-block";
        document.getElementById("logout-btn").style.display = "inline-block";
      }

      const func = async () => {
        fetch(`/profile/data/${userId}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data["msg"]){
              alert(`${data["msg"]}, please login again.`);
              window.location.href = "/auth/login";
            }
            if (userId == data.admin) is_admin = true;
            document.querySelector('.section-title').innerHTML  = `Posts by ${data.user.username}`;
            // profile view

            const profile_pic = null
            const header = document.getElementById("profile-header");
            header.innerHTML = "";

            header.innerHTML = `
            <button class="add_profile_btn"  onclick="goToAddProfilePic()">
      +
            </button>
            <img src="${data.user.profile_pictures ? `/static/profile_pictures/${data.user.profile_pictures}` : `/static/profile_pictures/default_profile.png`}" alt="Profile Picture" class="profile-picture">
        <div class="info-btn-container">
        <div class="profile-info">
            <h1 class="username">${data.user.username}</h1>
            <p class="email">${data.user.email}</p>
            <p class="join-date">Joined At: ${new Date(
              data.user.joined_at
            ).toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })}</p>

            <div class="stats">
                <span><strong>${data.user.posts.length}</strong> Posts</span>
            </div>
        </div>
        <div>
           <button
            id="create-post-btn"
            class="btn btn-primary"
            onclick="goToCreatePost()"
            
          >
            + Create New Post
          </button>
          
          <button
            id="logout-btn"
            class="btn btn-danger"
            onclick="logout()"
      
          >
            Logout
          </button>
        </div>
        
        </div>
        <div class="back-container">
      <a href="/" class="back_btn">X</a>
    </div>`;

            const container = document.getElementById("posts-container");
            container.innerHTML = "";

            if (!data.user_data || data.user_data.length === 0) {
              container.innerHTML = `<p class="no-posts">No posts available.</p>`;
              return;
            }

            // post view
            data.user_data.forEach((post) => {
              const hasImage = post.file && post.file.trim() !== "";
              const postDiv = document.createElement("div");
              postDiv.className = "post-card";

              postDiv.innerHTML = `
            <div>
              <h2>${post.title}</h2>
              <p class="meta">By <strong>${
                post.username
              }</strong> â€¢ Posted on ${post.created_at}</p>
              <div class="content-img ${
                hasImage ? "side-by-side" : "text-only"
              }">
                <p class="content">${post.content}</p>
                ${
                  hasImage
                    ? `<img src="/static/uploads/${post.file}" class="img" alt="Post Image" />`
                    : ""
                }
              </div>
            </div>
            <div class="actions">
              ${
                token && userId == post.user_id
                  ? `<a href="/post/edit-page/${post.id}" class="btn btn-primary">Edit</a>`
                  : ""
              }
              ${
                (token && userId == post.user_id) || is_admin
                  ? `<a onclick="deletePost(${post.id})" class="btn btn-danger">Delete</a>`
                  : ""
              }
            </div>
            <div class="comments-section">
              <h4>ðŸ’¬ Comments</h4>
              <div class="comments-list" id="comments-${post.id}">
                ${
                  post.comments && post.comments.length > 0
                    ? post.comments
                        .map(
                          (comment) => `
                            <div class="comment">
                              <div style="flex: 12;">
                                <p><strong>${comment.user.username}:</strong> ${
                            comment.content
                          }</p>
                                <p class="meta">${new Date(
                                  comment.created_at
                                ).toLocaleString()}</p>
                              </div>
                              <div style="flex: 1;">
                                ${
                                  is_admin
                                    ? `<a onclick="deleteComment(${comment.id})" class="btn btn-danger">Delete</a>`
                                    : ""
                                }
                              </div>
                            </div>
                          `
                        )
                        .join("")
                    : `<p class="no-comments">No comments yet.</p>`
                }
              </div>
              ${
                token
                  ? `
                    <form class="comment-form" onsubmit="submitComment(event, ${post.id})">
                      <input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment..." required />
                      <button type="submit" class="btn btn-small">Post</button>
                    </form>
                  `
                  : `<p class="comment-login-msg">Login to comment</p>`
              }
            </div>
          `;

              container.appendChild(postDiv);
            });
          })
          .catch((err) => {
            console.error("Error:", err);
            document.getElementById("posts-container").innerHTML =
              "<p style='color:red;'>Unable to fetch posts.</p>";
          });
      };

      const submitComment = (e, postId) => {
        e.preventDefault();
        const input = document.getElementById(`comment-input-${postId}`);
        const content = input.value.trim();
        if (!content) return;

        fetch(`/comment/add_comment/${postId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ content }),
        })
          .then((res) => res.json())
          .then(() => {
            input.value = "";
            func();
          })
          .catch(() => alert("Could not post comment."));
      };

      const deletePost = (postId) => {
        fetch(`/post/delete/${postId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            alert(data.message);
            func();
          })
          .catch((err) => alert("Error deleting post."));
      };

      const deleteComment = (commentId) => {
        fetch(`/admin/comment_delete/${commentId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            alert(data.message);
            func();
          })
          .catch(() => alert("Error deleting comment."));
      };

      function goToCreatePost() {
        window.location.href = "/post/create-page";
      }
      function logout() {
        localStorage.removeItem("access_token");
        localStorage.removeItem("user_id");
        window.location.href = "/";
      }

      function goToAddProfilePic() {
        window.location.href = `/profile/add_profile_pic/${userId}`;
      }

      func();
    </script>
  </body>
</html>
